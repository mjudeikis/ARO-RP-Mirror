parameters:
  location: ''
  subscription: ''
  azureDevOpsE2EJSONSPN: ''

steps:
# TODO(mj) we need to checkout code to run tooling like kubeconfig. This should go away once we refactor everything into golang.
- template: ./template-checkout.yml
- template: ./template-az-cli-login.yml
  parameters:
    azureDevOpsJSONSPN: ${{ parameters.azureDevOpsE2EJSONSPN }}
- script: |
    set -e
    export LOCATION=${{ parameters.location }}
    export AZURE_SUBSCRIPTION_ID=${{ parameters.subscription }}

    trap 'rm -f devops-spn.json' EXIT
    base64 -d >devops-spn.json <<<${{ parameters.azureDevOpsE2EJSONSPN }}
    export AZURE_CLIENT_ID=$(jq -r .clientId <devops-spn.json)
    export AZURE_CLIENT_SECRET=$(jq -r .clientSecret <devops-spn.json)
    export AZURE_TENANT_ID=$(jq -r .tenantId <devops-spn.json)

    set -x
    . ./hack/e2e/run-rp-and-e2e.sh

    run_e2e
  displayName: ðŸš€ Run ${{ parameters.location }} E2E
- template: ./template-az-cli-logout.yml
